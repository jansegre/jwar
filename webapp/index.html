<!DOCTYPE html>
<!-- vim: et sw=2 ts=2 sts=2
  -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<!--<link rel="shortcut icon" href="ico/favicon.png">-->

<title>JWar</title>

<!-- Bootstrap core CSS -->
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="//fonts.googleapis.com/css?family=Open+Sans:300,400" rel="stylesheet">

<!-- Custom styles for this template -->
<style>

body {
  min-width: 400px;
}

.jwar .well {
    padding: 0;
}

.jwar .panel-footer {
    background: white;
}

.map {
    padding: 0;
}
.map svg {
    max-height: 10000px;
    max-width: 5000px;
    margin-bottom: -4px;
}

.country-circle { fill: none }
.owner-azul     { fill: blue }
.owner-amarelo  { fill: yellow }
.owner-vermelho { fill: red }
.owner-verde    { fill: green }
.owner-branco   { fill: white }
.owner-preto    { fill: black }

.country-circle circle {
    stroke: #002;
    stroke-opacity: .5;
    stroke-width: .5px;
}

.country-label:hover, .country-circle:hover, .country:hover {
    cursor: pointer;
}

.country-label {
    display: block;
    fill: #aaa;
    font-family: "Open Sans";
    font-size: 14px;
    font-weight: 300;
    text-anchor: middle;
}

.country {
    fill: #999;
    stroke: #111;
    stroke-opacity: .8;
    stroke-width: .5px;
    stroke-linejoin: round;
}

.graticule {
    fill: none;
    stroke: #111;
    stroke-opacity: .1;
    stroke-width: .5px;
}

.outline {
    fill: none;
    stroke: #002;
    stroke-opacity: .5;
    stroke-width: .5px;
}

.country.AN.c0  { fill: #ffffff; }
.country.AF.c0  { fill: #a407b7; }
.country.AF.c1  { fill: #9418be; }
.country.AF.c2  { fill: #7008b4; }
.country.AF.c3  { fill: #8b05c5; }
.country.AF.c4  { fill: #9700b2; }
.country.AF.c5  { fill: #7d00af; }
.country.AS.c0  { fill: #d76100; }
.country.AS.c1  { fill: #ef5100; }
.country.AS.c2  { fill: #db3500; }
.country.AS.c3  { fill: #f14b05; }
.country.AS.c4  { fill: #fb6c08; }
.country.AS.c5  { fill: #ff8a1e; }
.country.AS.c6  { fill: #ff8427; }
.country.AS.c7  { fill: #ffb738; }
.country.AS.c8  { fill: #ff7f1c; }
.country.AS.c9  { fill: #ff5115; }
.country.AS.c10 { fill: #ff8007; }
.country.AS.c11 { fill: #ffa000; }
.country.AU.c0  { fill: #c10003; }
.country.AU.c1  { fill: #b40024; }
.country.AU.c2  { fill: #690016; }
.country.AU.c3  { fill: #9e0309; }
.country.EU.c0  { fill: #0094ec; }
.country.EU.c1  { fill: #002abb; }
.country.EU.c2  { fill: #0055da; }
.country.EU.c3  { fill: #0692f0; }
.country.EU.c4  { fill: #000f2b; }
.country.EU.c5  { fill: #0082b8; }
.country.EU.c6  { fill: #0069c9; }
.country.NA.c0  { fill: #ff9b13; }
.country.NA.c1  { fill: #e7d149; }
.country.NA.c2  { fill: #ffe627; }
.country.NA.c3  { fill: #eac42c; }
.country.NA.c4  { fill: #e4a200; }
.country.NA.c5  { fill: #ffed18; }
.country.NA.c6  { fill: #e4bb2c; }
.country.NA.c7  { fill: #bb9000; }
.country.NA.c8  { fill: #ffd600; }
.country.SA.c0  { fill: #00940d; }
.country.SA.c1  { fill: #00d211; }
.country.SA.c2  { fill: #41a223; }
.country.SA.c3  { fill: #19b512; }

/* chat styles */
.chat, .console {
  padding: 10px;
}

.chat-user {
  font-weight: bold;
}

.chat-user:after {
  content: ": ";
}

.chat-log {
  padding: 5px 10px 5px;
}

@media (min-width: 768px) {
  .chat-form .form-group, .command-form .form-group {
    width: 300px;
  }
}


</style>

<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
<![endif]-->

<!-- Fixed navbar -->
<div class="navbar navbar-default navbar-static-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">JWar</a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="active"><a href="#">Home</a></li>
        <!--
        <li><a href="#about">About</a></li>
        <li><a href="#contact">Contact</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a href="#">Action</a></li>
            <li><a href="#">Another action</a></li>
            <li><a href="#">Something else here</a></li>
            <li class="divider"></li>
            <li class="dropdown-header">Nav header</li>
            <li><a href="#">Separated link</a></li>
            <li><a href="#">One more separated link</a></li>
          </ul>
        </li>
        -->
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="#"><i class="glyphicon glyphicon-remove"></i> Quit</a></li>
      </ul>
    </div>
  </div>
</div>

<div class="container jwar">

  <!-- Main component for a primary marketing message or call to action -->
  <!--
  <div class="well map"></div>
  -->
  <div class="row">
    <div class="panel panel-default well hide map-screen">
      <div class="panel-body map"></div>
      <div class="panel-footer">
        <span class="label label-default selected-country">&nbsp;</span>
      </div>
    </div>
  </div>

  <!-- chat -->
  <div class="row well">
    <div class="command col-md-6">
      <!--<h4>Chat</h4>-->
      <div class="console">
      </div>

      <form class="form-inline command-form" role="form">
        <div class="form-group">
          <input class="cmd form-control" type="text" placeholder="Digite um comando...">
        </div>
        <input type="submit" class="btn btn-default" value="Enviar">
      </form>
    </div>
    <div class="chat col-md-6">
      <!--<h4>Chat</h4>-->
      <div class="console">
      </div>

      <form class="form-inline chat-form" role="form">
        <div class="form-group">
          <input class="msg form-control" type="text" placeholder="Digite sua mensagem...">
        </div>
        <input type="submit" class="btn btn-default" value="Enviar">
      </form>
    </div>
  </div>

</div> <!-- /container -->

<!-- Placed at the end of the document so the pages load faster -->
<script src="js/jquery-2.0.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/d3.v3.min.js"></script>
<script src="js/d3.geo.projection.v0.min.js"></script>
<script src="js/topojson.v1.min.js"></script>
<script src="js/socket.io/socket.io.js"></script>
<script>
(function(){
  var width = 1000, height = 500;

  var map = d3.select(".map");
  var screen = d3.select(".map-screen");
  var svg = map.append("svg")
    .attr("viewBox", "0 0 " + width + " " + height)
    .attr("preserveAspectRatio", "xMinYMin meet");
    //.attr("width", "100%")
    //.attr("height", height);
  window.svg = svg;//DEBUG
  var defs = svg.append("defs")
  var selected_country = d3.select(".selected-country");

  //var filter = defs.append("filter").attr("id", "shadow");
  //filter.append("feMorphology")
  //  .attr("in", "SourceGraphic")
  //  .attr("radius", 1.0)
  //  .attr("operator", "dilate")
  //  .attr("result", "dilated");
  //filter.append("feColorMatrix")
  //  .attr("in", "dilated")
  //  .attr("result", "textbg")
  //  .attr("type", "matrix")
  //  .attr("values",
  //    "-0.4 -0.3 -0.3 0   1   " +
  //    "-0.3 -0.4 -0.3 0   1   " +
  //    "-0.3 -0.3 -0.4 0   1   " +
  //    " 0    0    0   1   0   ");
  //var merge = filter.append("feMerge")
  //merge.append("feMergeNode").attr("in", "textbg");
  //merge.append("feMergeNode").attr("in", "SourceGraphic");

  // Possible projections
  var projections = [
    //0
    d3.geo.kavrayskiy7()
      .scale(200),
    d3.geo.eckert4()
      .scale(200)
      .translate([width / 2, height / 2]),
    d3.geo.cylindricalStereographic()
      .parallel(45)
      .scale(230)
      .translate([width / 2, height / 2 + 50]),
    d3.geo.miller()
      .scale(180)
      .translate([width / 2, height / 2 + 50]),
    //4
    d3.geo.equirectangular()
      .scale(160)
      .translate([width / 2, height / 2])
      .precision(.1),
    d3.geo.naturalEarth()
      .scale(220)
      .translate([width / 2, height / 2 + 30])
      .precision(.1),
    d3.geo.lagrange()
      .scale(260)
      .translate([width / 2, height / 2 + 50])
      .precision(.1),
    d3.geo.orthographic()
      .scale(250)
      .translate([width / 2, height / 2])
      .clipAngle(92),
    //8
    d3.geo.stereographic()
      .scale(245)
      .translate([width / 2, height / 2])
      .rotate([-20, 0])
      .clipAngle(180 - 1e-4)
      .clipExtent([[0, 0], [width, height]])
      .precision(.1)
  ]

  var projection = projections[4];

  var color = d3.scale.category20();
  var graticule = d3.geo.graticule();
  var path = d3.geo.path().projection(projection);
  //var transform = function(d) { return "translate(" + path.centroid(d) + ")"; }
  var transform = function(d) { return "translate(" + projection(d.geometry.coordinates) + ")"; }

  svg.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", path);

  svg.append("path")
    .datum(graticule.outline)
    .attr("class", "outline")
    .attr("d", path);

  // helper functions to transform
  // screen positions on rotation coordinates

  var λ = d3.scale.linear()
    .domain([0, width])
    .range([-180, 180]);

  var φ = d3.scale.linear()
    .domain([0, height])
    .range([90, -90]);

  // the drag

  map.on("click", function(d,i) {
    //if (d3.event.defaultPrevented) return; // click suppressed
  });

  var dragthis;
  var _lr;
  map.call(d3.behavior.drag()
    // remember rotation
    .on("dragstart", function() {
      var m = d3.mouse(this);
      var p = projection.rotate();
      _lr = [p[0] - λ(m[0]) , p[1] - φ(m[1])];
      // optimizations
      //svg.selectAll(".country-label").classed("moving", true);
    })
    // do a delta rotation
    .on("drag", function() {
      var m = d3.mouse(this);
      var r = [λ(m[0]) + _lr[0], 0];
      //var r = [λ(m[0]) + _lr[0], φ(m[1]) + _lr[1]];
      projection.rotate(r);
      svg.selectAll(".country,.graticule").attr("d", path);
      svg.selectAll(".country-label").attr("transform", transform);
      svg.selectAll(".country-circle").attr("transform", circleTransform);
    })
    // clean up optimizations
    .on("dragend", function() {
      //svg.selectAll(".country-label").classed("moving", false);
    })
  );

  var packsize = 40;
  var pack = d3.layout.pack().size([packsize, packsize]);
  function armyList(armies) {
    var l = {children:[]};
    while (armies > 5) {
      l.children.push({value: 5});
      armies -= 5;
    }
    while (armies > 0) {
      l.children.push({value: 1});
      armies--;
    }
    window.nodes = pack.nodes(l);
    return pack.nodes(l).filter(function(d) { return !d.children; });
  }

  var cont_sizes = {
    AF: 6,
    AS: 12,
    AU: 4,
    EU: 7,
    NA: 9,
    SA: 4,
    AN: 1
  }

  function circleTransform(d) {
    return transform(d) + " rotate(" + (d.rotation = (d.rotation || (Math.random() * 360))) + ")";
  }

  function loadMap(mapfile) {
    d3.json(mapfile, function(error, world) {
      var countries = topojson.feature(world, world.objects.countries).features,
      neighbors = topojson.neighbors(world.objects.countries.geometries),
      labels = topojson.feature(world, world.objects.labels).features;
      window.world = world;

      svg.selectAll(".country")
        .data(countries)
        .enter().insert("path", ".graticule")
        .attr("class", function(d, i) { return ["country", d.properties.CONT , "c" + (d.id % cont_sizes[d.properties.CONT])].join(" "); })
        .attr("data-country", function(d) { return d.properties.CC })
        .attr("d", path);
        //.style("fill", function(d, i) { return color(d.color = d3.max(neighbors[i], function(n) { return countries[n].color; }) + 1 | 0); });

      //svg.selectAll(".country-circle")
      //  .data(labels)
      //  .enter().append("circle")
      //  .attr("class", "country-circle")
      //  .attr("id", function(d) { return d.properties.CC })
      //  .attr("transform", transform)
      //  .attr("r", "9")
      //  .attr("data-country", function(d) { return d.properties.CC })

      svg.selectAll(".country-circle")
        .data(labels)
        .enter().append("g")
        .attr("class", "country-circle")
        .attr("id", function(d) { return d.properties.CC })
        //.attr("transform", transform)
        //.attr("transform", function(d) { return "rotate(25) " + transform(d); })
        .attr("transform", circleTransform)
        .attr("data-country", function(d) { return d.properties.CC })

      svg.selectAll(".country-label")
        .data(labels)
        .enter().append("text")
        .attr("class", "country-label")
        .attr("id", function(d) { return d.properties.CC })
        .attr("transform", transform)
        .attr("dy", ".35em")
        .attr("data-country", function(d) { return d.properties.CC })
        ;//.text(function(d) { return d.properties.NAME; });

      svg.selectAll(".country,.country-label,.country-circle")
        .on("click", function(d,i) {
          selected_country
          .html(d.properties.CC + ": " + d.properties.NAME);
        });
    });
    screen.classed("hide", false);
  }

  // API communication
  var _ns = 'br.eb.ime.jwar.webapi.';
  var user = 'Usuário ' + Math.floor((Math.random()*1000)+1);
  console.log(user);
  var endpointBase = location.protocol + '//' + location.hostname + ':9092';
  var chatEndpoint = endpointBase + '/chat';
  var apiEndpoint = endpointBase + '/api';
  var chatSocket =  io.connect(chatEndpoint);
  var apiSocket = io.connect(apiEndpoint);

  chatSocket.on('message', function (data) {
    var chat_log = $('<div>').addClass("chat-log");
    if (data.user)
      chat_log.append($("<span>").addClass("chat-user").text(data.user));
    if (data.message)
      chat_log.append($("<span>").addClass("chat-message").text(data.message))
    $('.chat .console').append(chat_log);
  });

  apiSocket.on('connect', function () {
    console.log("Connected to the server, loading map...");
  });

  apiSocket.on('disconnect', function () {
    console.log("Disconnected from server!");
    retries = 10;
    mapfile = null;
  });

  apiSocket.on('message', function (data) {
    console.log(data);

    if (data.output) {
      var cmd_log = $('<div>');
      cmd_log.append($("<pre>").addClass("console-log").text(data.output));
      $('.command .console').append(cmd_log);
      return;
    }

    // load the map if recently connected
    if (data.welcome)
      loadMap(data.mapfile);

    // update the state
    setTimeout(function() {
      data.tabuleiro.continentes.forEach(function (cont) {
        cont.paises.forEach(function (pais) {
          var colorclass = "owner-" + (pais.corDono || "").toLowerCase();
          var circles = svg.select("#" + pais.codigo + ".country-circle")
            .selectAll("circle")
            .data(armyList(pais.exercitos))
            .attr("r", function(d) { return d.value + 3.5; })
            .attr("cx", function(d) { return d.x - packsize / 2; })
            .attr("cy", function(d) { return d.y - packsize / 2; })
          window.circles = circles
          circles.enter()
            .append("circle")
            .attr("r", function(d) { return d.value + 3.5; })
            .attr("cx", function(d) { return d.x - packsize / 2; })
            .attr("cy", function(d) { return d.y - packsize / 2; })
            .attr("class", colorclass)
          circles.exit()
            .remove()
          //d3.select("#" + pais.codigo + ".country-label")
            //.text(pais.exercitos);
            //.text(pais.nome + " [" + pais.exercitos + "]");
        });
      });
    }, 500); // hack to wait for countries to load
  });

  window.sendCommand = function (command) {
    apiSocket.json.send({
        '@class': _ns + 'CommandObject',
        command: command
    });
  }

  $(".chat-form").on('submit', function (e) {
    e.preventDefault();

    // get the message and clear the form
    var message = $('.chat-form .msg').val();
    $('.chat-form .msg').val('');

    //console.log(user + ": " + message);
    chatSocket.json.send({
      '@class': _ns + 'ChatObject',
      user: user,
      message: message
    });
    //chatSocket.emit('chatevent', {user: user, message: message});
  });

  $(".command-form").on('submit', function (e) {
    e.preventDefault();

    // get the message and clear the form
    var command = $('.command-form .cmd').val();
    $('.command-form .cmd').val('');

    apiSocket.json.send({
        '@class': _ns + 'CommandObject',
        command: command
    });
  });
})();
</script>
